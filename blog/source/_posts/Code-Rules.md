---
title: Code Rules
date: 2018-08-25 15:23:44
tags:
---

> 因为之前都没有很严格的代码规范，所以这周开始制定代码规范，大致从五部分来做。
> 【强制】严格遵守 PSR 规范，详尽的 PSR 规范可以点击链接访问[URL 链接](#)([https://psr.phphub.org/](https://psr.phphub.org/))

<!--more-->

### 0x00  团队代码规范

- 命名规范 ✅
- 代码片段 ✅
- 数据库设计✅
- 开发守则  ✅

#### 关于 Code 的规范

> PHP 系列可以参考 PSR 规范，[PSR](https://psr.phphub.org/ "PSR 标准规范")([https://psr.phphub.org/](https://psr.phphub.org/))
> JavaScript 可以参考 [JS URL](https://github.com/fex-team/styleguide/blob/master/javascript.md)([https://github.com/fex-team/styleguide/blob/master/javascript.md](https://github.com/fex-team/styleguide/blob/master/javascript.md))
> 关于 MySQL 的规范可以参考《阿里巴巴 Java 开发手册中》的数据库部分

- PHP代码文件 必须 以 `<?php` 或 `<?=` 标签开始；
- PHP代码文件 必须 以 `不带 BOM 的 UTF-8 编码`；
- PHP代码中 应该 只定义类、函数、常量等声明，或其他会产生 副作用 的操作（如：生成文件输出以及修改 `.ini ` 配置文件等），二者只能选其一；

### 0x01、命名规范
1. 【强制】代码中的命名严禁使用拼音与英文混合的方式，更不允许直接使用中文的方式。
    说明： 正确的英文拼写和语法可以让阅读者易于理解，避免歧义。注意，即使纯拼音命名方式，但是一些在英文中无法对应的词语可以使用拼音，如搬砖等。但是拼音方案也要尽量避免采用，变量必须有所含义，不允许出现`$data`,`$a` 等无意义的变量名。

2. 【强制】类名使用 `UpperCamelCase` 风格，但以下情形例外：`DO / BO / DTO / VO / AO /PO / UID` 等。
    说明：关于 `ThinkPHP` 框架下开发的时候要遵循框架开发的规则，对于 `Controller` 的文件命名不做强制要求。
    正例： `MarcoPolo / UserDO / XmlService / TcpUdpDeal / TaPromotion`

3. 【强制】类内方法名、类内参数名、成员变量、局部变量都统一使用`lowerCamelCase`风格，必须遵从驼峰形式。
    正例：`localValue / getHttpMessage() / inputUserId`

4. 【强制】抽象类命名使用 `Abstract` 开头； 异常类命名使用 `Exception` 结尾； 测试类命名以它要测试的类的名称开始，以 `Test` 结尾。

5. 【强制】常量命名、配置参数和语言变量全部大写，单词间用下划线隔开，力求语义表达完整清楚，不要嫌名字长。
    例如 `HAS_ONE`和 `MANY_TO_MANY`；语言变量例如`MY_LANG`，以下划线打头的语言变量通常用于系统语言变量，例如 `_CLASS_NOT_EXIST_`；

6. 【强制】杜绝完全不规范的缩写， 避免望文不知义。
    反例： `AbstractClass`“缩写” 命名成 `AbsClass`； `condition`“缩写” 命名成 `condi`，此类随意缩写严重降低了代码的可阅读性。

7. 【推荐】如果模块、 接口、类、方法使用了设计模式，在命名时需体现出具体模式。
    说明： 将设计模式体现在名字中，有利于阅读者快速理解架构设计理念。
    正例： `public class OrderFactory`;`public class LoginProxy`;
    `public class ResourceObserver`;

8. 【参考】各层命名规约，遵守`Service/DAO` 层方法命名规约
    1） 获取单个对象的方法用 `get` 做前缀。
    2） 获取多个对象的方法用 `list` 做前缀，复数形式结尾如： `listObjects`。
    3） 获取统计值的方法用 `count` 做前缀。
    4） 插入的方法用 `save/insert` 做前缀。
    5） 删除的方法用 `remove/delete` 做前缀。
    6） 修改的方法用 `update` 做前缀。

9. 关于 `ThinkPHP` 的一些需要遵守的地方也需要注意
    - 类文件都是以`.class.php`为后缀（这里是指的`ThinkPHP`内部使用的类库文件，不代表外部加载的类库文件），使用驼峰法命名，并且首字母大写，例如 `DbMysql.class.php`；
    - 类的命名空间地址和所在的路径地址一致，例如 `Home\Controller\UserController`类所在的路径应该是 `Application/Home/Controller/UserController.class.php`；
    - 确保文件的命名和调用大小写一致，是由于在类`Unix`系统上面，对大小写是敏感的（而`ThinkPHP`在调试模式下面，即使在`Windows`平台也会严格检查大小写）；
    - 类名和文件名一致（包括上面说的大小写一致），例如 `UserController`类的文件命名是`UserController.class.php`，`InfoModel`类的文件名是`InfoModel.class.php`， 并且不同的类库的类命名有一定的规范；
    - 函数、配置文件等其他类库文件之外的一般是以.php为后缀（第三方引入的不做要求）；
    - 函数的命名使用小写字母和下划线的方式，例如 `get_client_ip` ；
    - 类内方法的命名使用驼峰法，并且首字母小写或者使用下划线 `_`，例如 `getUserName`，`_parseType`，下划线开头的方法属于私有方法；
    - 类内属性的命名使用驼峰法，并且首字母小写或者使用下划线 `_`，例如 `tableName`、`_instance `，下划线开头的属性属于私有属性；
    - 以双下划线`__`打头的函数或方法作为魔法方法，例如 `__call` 和 `__autoload`；
    - 常量必须大写字母和下划线命名，例如 `HAS_ONE` 和 `MANY_TO_MANY`；
    - 配置参数以大写字母和下划线命名，例如 `HTML_CACHE_ON`；
    - 语言变量以大写字母和下划线命名，例如 `MY_LANG`，以下划线打头的语言变量通常用于系统语言变量，例如 `_CLASS_NOT_EXIST_`；
    - ThinkPHP的模板文件默认是以 `.html` 为后缀（可以通过配置修改）；
    - 数据表和字段采用小写加下划线方式命名，并注意字段名不要以下划线开头，例如 `think_user` 表和 `user_name` 字段是正确写法，类似 `_username` 这样的数据表字段可能会被过滤。

### 0x02 代码片段

1. 【强制】代码使用4个空格符而不是「Tab 键」进行缩进（这里可以在`PhpStorm`的配置中设置）。

2. 【强制】每个 `namespace` 命名空间声明语句和 `use` 声明语句块后面，必须插入一个空白行。

3. 【强制】类的开始花括号 `{` 必须写在函数声明后自成一行，结束花括号 `}` 也必须写在函数主体后自成一行。

4. 【强制】方法的开始花括号 `{` 必须写在函数声明后自成一行，结束花括号 `}` 也必须写在函数主体后自成一行。

5. 【强制】类的属性和方法必须添加访问修饰符 `private`、`protected` 以及 `public`，`abstract` 以及 `final`必须声明在访问修饰符之前，而 `static` 必须声明在访问修饰符之后。

6. 【强制】控制结构的关键字后必须要有一个空格符，而调用方法或函数时则一定不可有。

7. 【强制】控制结构的开始花括号 `{` 必须写在声明的同一行，而结束花括号 `}` 必须写在主体后自成一行。

8. 【强制】控制结构的开始左括号后和结束右括号前，都 _**一定不可**_ 有空格符。

9. 【推荐】单行注释无比使用 `//`来进行标注，和下一行代码对齐

10. 【推荐】多行注释，可以使用 `/**/` 来做注释开头和结尾

11. 【推荐】简单的接口不需要些注释，不要写过多的注释，复杂的逻辑注释注意准确性和时效性，如果注释已经失效，记得更新日志。否则删掉。

12. 前端的 `JS` 文件和 `HTML` 文件上线时需要删除注释内容。前端不适宜写过多的注释内容，以备留下安全隐患。

13. 【推荐】没有必要增加若干空格来使某一行的字符与上一行对应位置的字符对齐。
    正例：
    ```java
    int one = 1;
    long two = 2L;
    float three = 3F;
    StringBuffer sb = new StringBuffer();
    ```
    说明： 增加 sb 这个变量，如果需要对齐，则给 a、 b、 c 都要增加几个空格，在变量比较多的情况下，是非常累赘的事情

##### 正确示例如下

```php
<?php
namespace Vendor\Package;

use FooInterface;
use BarClass as Bar;
use OtherVendor\OtherPackage\BazClass;

class Foo extends Bar implements FooInterface
{
    public function sampleFunction($a, $b = null)
    {
        if ($a === $b) {
            bar();
        } elseif ($a > $b) {
            $foo->bar($arg1);
        } else {
            BazClass::bar($arg2, $arg3);
        }
    }

    final public static function bar()
    {
        // 方法的内容
        $argc = array();
    }
}
```

### 0x02 开发守则

1. 开发过程中保持和产品、测试的实时沟通，切勿`独立`开发，有了新的 `idea`，要记得及时和产品沟通。每一个确定的需求都要保证开发，测试和产品是清楚无误的。

2. 在开始新的迭代的时候，再三沟通，再三沟通，再三沟通好要迭代的内容。

3. 下笔之前，多思考。`THINK MORE, CODE LESS`

4. 每个函数不超过 `50` 行，非强制性，但绝对不可以超过 `150` 行，开发过程中应当避免每个方法过长，适时解构，不要让代码耦合性过强。

5. 无论是`laravel` 或者`ThinkPHP`哪一个框架，`Controller`中的`func` 不要太复杂。复杂逻辑写在相对应的`Service`或者`Logic`中。

6. `Controller`中不允许直接调用`Model`

7. 在每次的上线时维护好上线文档。一次小上线也要记录好本次上线的内容。

8. 不要盲目的拷贝，粘贴。要知道拷贝粘贴节约的时间没有多少。把方法解耦，提取公共方法。这样才是长久之计。

9. 对自己的代码要负责，要有强烈的羞耻心。

10. 多记录日志，对每一个步骤流程都做日志流程记录，尤其是订单流程。这样出现问题排查起来很方便。

11. 不断思考，不断前进。

12. 请尽量使用 `teambition` 合作, 约束自己

13. 多自我学习, 没工作内容的时候才是成长的好机会

14. 多交流

15. ` SVN commit` 有目的的时候, 尽量填写 `msg`, 不要改改就提交

16. 复制的代码一定要改注释, 保持注释的正确性

17. 写死数据进行测试是可以的, 但是测试完了要去掉(如果没用)

18. 阅读下其他盆友的代码, 熟悉流程, 不能只知道自己的小块, 至少要知道个大概流程吧.

19. 注意`api`的兼容性，`response`结构不要删减；注意数据类型的一致性

20. 接口完成后如果可以请录入`postman`，并告知客户端盆友改动项

21. 注意如果`apivN`改了, 也要考虑下`apiM`的情况, 比如说`api1`不再支持微信资料的覆盖, 这种改变, `api`也是肯定不能支持的, 都要改掉!; 而如果是`api1`加了某个字段, `api`不需要用到, 那可以不加.

22. 个人感觉不要用一样的命名, 我刚才搜索一个方法, `controller`, `logic`, `model`里全叫一个名字; 实例化后的变量名也不容易作为搜索条件区分, 一搜就悲剧了. 大家注意`controller`里是给用户访问的入口, `logic`里是集合的操作, `model`里是对数据库的操作, 以此来定名字.

### 0x31 数据库设计

##### 命名规则 
1. 【强制】表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只出现数字。数据库字段名的修改代价很大，所以字段名称需要慎重考虑。说明：`MySQL`在`Windows`下不区分大小写，但在`Linux`下默认是区分大小写。因此，数据库名、表名、字段名，都不允许出现任何大写字母，避免节外生枝。正例：`aliyun_admin`，`rdc_config`，`level3_name` 反例：`AliyunAdmin`，`rdcConfig`，`level_3_name` 

2. 【强制】表名字段名不使用英文与拼音的复合表达式，符合表达习惯。禁用保留字，如`desc`、`date`、`range、match、delayed`等，请参考MySQL官方保留字。

3. 【强制】主键索引名为`pk_`字段名；唯一索引名为`uk_`字段名；普通索引名则为`idx_`字段名。 说明：`pk_` 即`primary key`；`uk_` 即 `unique key`；`idx_` 即`index`的简称。 

##### 表/字段规则

1. 【强制】不得使用外键与级联，一切外键概念必须在应用层解决。 说明：以学生和成绩的关系为例，学生表中的`student_id`是主键，那么成绩表中的`student_id`则为外键。如果更新学生表中的`student_id`，同时触发成绩表中的`student_id`更新，即为级联更新。外键与级联更新适用于单机低并发，不适合分布式、高并发集群；级联更新是强阻塞，存在数据库更新风暴的风险；外键影响数据库的插入速度。 

2. 【强制】所有的字符存储与表示，均以`utf-8`编码，注意字符统计函数的区别。 

3. 【强制】如果存储的字符串长度几乎相等，使用`char`定长字符串类型。 

4. 【强制】`varchar`是可变长字符串，不预先分配存储空间，长度不要超过 2000，如果存储长度大于此值，定义字段类型为`text`，独立出来一张表，用主键来对应，避免影响其它字段索引效率。 

5. 【推荐】表必备三字段：`id, createon, updateon`。 说明：其中id必为主键，类型为`bigint unsigned`、单表时自增、步长为1。`createon, updateon`的类型均为`datetime`类型。

6. 【推荐】所有字段都应该有默认值，不应该存在值为`NULL`的列，`NULL`值在统计中会造成很多麻烦。 

7. 【推荐】字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循：
     1）不是频繁修改的字段。
     2）不是`varchar`超长字段，更不能是`text`字段。 正例：商品类目名称使用频率高，字段长度短，名称基本一成不变，可在相关联的表中冗余存储类目名称，避免关联查询。 

8. 【推荐】单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。 说明：如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。 

##### 索引规则

1. 【强制】勿认为一个查询就需要建一个索引，也不要胡乱认为索引会消耗空间、严重拖慢更新和新增速度，而是应该业务需求考虑索引的必要程度。

2. 【强制】对于有限的几个值的列不需要建索引。 

3. 【强制】经常出现在`where`条件和`order by`子句中的列一定要建立索引。

4. 【强制】业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引。 
    说明：不要以为唯一索引影响了`insert`速度，这个速度损耗可以忽略，但提高查找速度是明显的；另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必然有脏数据产生。 

5. 【强制】在`varchar`字段上建立索引时，必须指定索引长度，一般来说 8 位即可，没必要对全字段建立索引，根据实际文本区分度决定索引长度即可。 

6. 【推荐】 `SQL`性能优化的目标：至少要达到 `range` 级别，要求是`ref`级别，如果可以是`consts`最好。 
    说明：
     1）`consts` 单表中最多只有一个匹配行（主键或者唯一索引），在优化阶段即可读取到数据。
     2）`ref` 指的是使用普通的索引（`normal index`）。
     3）`range` 对索引进行范围检索。 反例：`explain`表的结果，`type=index`，索引物理文件全扫描，速度非常慢，这个`index`级别比较`range`还低，与全表扫描是小巫见大巫。 

##### SQL语句 

1. 【强制】不要使用`count(列名)`或`count(常量)`来替代`count(*)`，`count(*)`是`SQL92`定义的标准统计行数的语法，跟数据库无关，跟`NULL`和非`NULL`无关。 说明：`count(*)`会统计值为`NULL`的行，而`count(列名)`不会统计此列为`NULL`值的行。 

2. 【强制】`order by`排序的时候如果是根据创建时间来排序，不要使用`createon`列，直接用`order by id` 或者`order by id desc`。说明：通过主键来排序大幅提高性能。

3. 【强制】 在代码中写分页查询逻辑时，若`count`为0应直接返回，避免执行后面的分页语句。 

4. 【强制】`where`条件中如果字段是字符类型，代码中的条件值必须加上引号，避免索引失效。 

5. 【强制】在表查询中，一律不要使用 * 作为查询的字段列表，需要哪些字段必须明确写明。 说明：1）增加查询分析器解析成本；2）无用字段增加网络消耗，尤其是text类型的字段。 

6. 【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。 

7. 【强制】 除临时表外程序中禁止使用`TRUNCATE TABLE` 。说明：`TRUNCATE TABLE` 在功能上与不带 `WHERE` 子句的 `DELETE` 语句相同，极有可能造成事故。 

8. 【推荐】`in`操作能避免则避免，若实在避免不了，需要仔细评估`in`后边的集合元素数量，控制在1000个之内。 

9. 【推荐】不要写一个大而全的数据更新接口。不管是不是自己的目标更新字段，都进行`update table set c1=value1,c2=value2,c3=value3; `这是不对的。执行`SQL`时，不要更新无改动的字段，一是易出错；二是效率低；三是增加`binlog`存储。 

10. 【推荐】利用延迟关联或者子查询优化超多分页场景。 说明：`MySQL`并不是跳过`offset`行，而是取`offset+N`行，然后返回放弃前`offset`行，返回`N`行，那当`offset`特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过特定阈值的页数进行`SQL`改写。 正例：先快速定位需要获取的`id`段，然后再关联： `SELECT a.* FROM 表1 a, (select id from 表1 where 条件 LIMIT 100000,20 ) b where a.id=b.id `

11. 【推荐】建组合索引的时候，区分度最高的在最左边。 正例：如果`where a=? and b=? `，如果`a`列的几乎接近于唯一值，那么只需要单建`idx_a`索引即可。 说明：存在非等号和等号混合时，在建索引时，请把等号条件的列前置。如：`where c>? and d=?` 那么即使`c`的区分度更高，也必须把d放在索引的最前列，即索引`idx_d_c`。 

12. 【推荐】超过三个表禁止`join`。需要`join`的字段，数据类型必须绝对一致；多表关联查询时，保证被关联的字段需要有索引。 说明：即使双表`join`也要注意表索引、`SQL`性能。 

